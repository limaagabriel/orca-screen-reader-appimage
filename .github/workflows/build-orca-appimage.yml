name: Build ORCA AppImage

on:
  push:
    branches: [ main, master ]
  pull_request: 
    branches: [ main, master ]
  workflow_dispatch:

jobs: 
  build-appimage: 
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          python3 \
          python3-pip \
          python3-setuptools \
          python3-dev \
          python3-gi \
          python3-gi-cairo \
          gir1.2-gtk-3.0 \
          gir1.2-wnck-3.0 \
          gir1.2-atspi-2.0 \
          libatspi2.0-dev \
          libglib2.0-dev \
          intltool \
          itstool \
          gettext \
          desktop-file-utils \
          liblouis-dev \
          liblouis-data \
          python3-louis \
          python3-pyatspi \
          python3-speechd \
          python3-brlapi \
          python3-xdg \
          xbrlapi \
          brltty \
          speech-dispatcher \
          wget \
          fuse \
          libfuse2
    
    - name: Install Python dependencies
      run: |
        pip3 install --upgrade pip
    
    - name: Build ORCA
      run: |
        ./autogen.sh --prefix=/usr
        make
        make install DESTDIR=${{ github.workspace }}/AppDir
    
    - name: Download AppImage tools
      run: |
        wget https://github.com/linuxdeploy/linuxdeploy/releases/download/continuous/linuxdeploy-x86_64.AppImage
        chmod +x linuxdeploy-x86_64.AppImage
    
    - name: Create AppDir structure
      run: |
        mkdir -p AppDir/usr/share/applications
        mkdir -p AppDir/usr/share/icons/hicolor/256x256/apps
        
        # Create desktop file if it doesn't exist
        cat > AppDir/usr/share/applications/orca. desktop << 'EOF'
        [Desktop Entry]
        Version=1.0
        Type=Application
        Name=Orca Screen Reader
        Comment=Screen reader for individuals who are blind or visually impaired
        Exec=orca
        Icon=orca
        Terminal=false
        Categories=Accessibility;GTK;
        StartupNotify=true
        EOF
        
        # Copy or create icon
        if [ -f "icons/hicolor/256x256/apps/orca.png" ]; then
          cp icons/hicolor/256x256/apps/orca.png AppDir/usr/share/icons/hicolor/256x256/apps/
        else
          # Create a placeholder icon if none exists
          convert -size 256x256 xc:blue -pointsize 72 -fill white -gravity center \
            -annotate +0+0 "ORCA" AppDir/usr/share/icons/hicolor/256x256/apps/orca.png || \
            touch AppDir/usr/share/icons/hicolor/256x256/apps/orca.png
        fi
    
    - name: Bundle Python and dependencies
      run: |
        # Copy Python installation
        mkdir -p AppDir/usr/bin
        mkdir -p AppDir/usr/lib
        
        # Copy Python runtime
        cp -r /usr/bin/python3* AppDir/usr/bin/
        cp -r /usr/lib/python3* AppDir/usr/lib/
        
        # Copy GI bindings and dependencies
        cp -r /usr/lib/python3/dist-packages/gi AppDir/usr/lib/python3*/dist-packages/ || true
        cp -r /usr/lib/x86_64-linux-gnu/girepository-1.0 AppDir/usr/lib/ || true
    
    - name: Create AppImage
      run: |
        ./linuxdeploy-x86_64.AppImage \
          --appdir AppDir \
          --output appimage \
          --desktop-file AppDir/usr/share/applications/orca.desktop \
          --icon-file AppDir/usr/share/icons/hicolor/256x256/apps/orca.png
    
    - name: Upload AppImage artifact
      uses: actions/upload-artifact@v4
      with:
        name: ORCA-AppImage
        path:  ./*.AppImage
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: ./*.AppImage
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
